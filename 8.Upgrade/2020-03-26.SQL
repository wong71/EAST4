USE EAST4
GO


--1.表结构 
--1.1.新表
--1.1.1.公司部门信息表
IF  NOT EXISTS(SELECT 1 FROM sysobjects WHERE NAME = 'TEDEPART') BEGIN
    CREATE TABLE TEDEPART
    (
            DEPART_ID           INTEGER         NOT NULL  IDENTITY,     --自动编号做主键
            PARENT_ID           INTEGER         NOT NULL,               --父级部门ID
            DEPART_CODE         NVARCHAR(40)    NOT NULL,               --部门代码
            DEPART_NAME         NVARCHAR(200)   NOT NULL,               --部门名称
            CLASS               NVARCHAR(100)   NOT NULL,               --部门分类(2012)
            MANAGER1            NVARCHAR(200)   NOT NULL,               --部门经理1
            MANAGER2            NVARCHAR(200)   NOT NULL,               --部门经理2
            LEADER              NVARCHAR(200)   NOT NULL,               --分管领导
            SUMMARY             NVARCHAR(2000)                          --部门说明
            CONSTRAINT PRI_TEDEPART PRIMARY KEY(DEPART_ID)
    )
    CREATE UNIQUE INDEX IDX_TEDEPART ON TEDEPART(DEPART_CODE)
END


--1.1.2.系统版本信息
IF NOT EXISTS(SELECT 1 FROM sysobjects WHERE name = 'TEVERSIONDETAIL') BEGIN
    CREATE TABLE TEVERSIONDETAIL
    (
        SERIAL_NO           INTEGER         NOT NULL    IDENTITY            ,--记录号
        VERSION_NO          NVARCHAR(40)    NOT NULL                        ,--版本号
        RELEASE_DATE        INTEGER                                         ,--发布日期
        DEPLOY_DATE         DATETIME        NOT NULL    DEFAULT GETDATE()   ,--部署日期
        SUMMARY             NVARCHAR(MAX)                                   ,--版本说明
        CONSTRAINT PRI_TEVERSIONDETAIL PRIMARY KEY(SERIAL_NO)
    )
    CREATE UNIQUE INDEX IDX_TEVERSIONDETAIL1 ON TEVERSIONDETAIL(VERSION_NO)
    CREATE UNIQUE INDEX IDX_TEVERSIONDETAIL2 ON TEVERSIONDETAIL(RELEASE_DATE)
END
--1.2. 新增字段
--1.2.1. TESYSTEMINFO
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TESYSTEMINFO') and name = 'VERSION_NO') BEGIN
    ALTER TABLE TESYSTEMINFO ADD  VERSION_NO NVARCHAR(40)   --版本号
END
--1.2.2. TEREPORT.REPORT_FLAG
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TEREPORT') and name = 'REPORT_FLAG') BEGIN

    ALTER TABLE TEREPORT ADD REPORT_FLAG INTEGER NOT NULL   DEFAULT 1   --申报标志：1-EAST申报表 2-其他表
END


--1.2.3. TA01JGXXB 机构信息表
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA01JGXXB') and name = 'CHECK_FLAG') BEGIN
    ALTER TABLE TA01JGXXB ADD  CHECK_FLAG INTEGER   NOT NULL DEFAULT 1   --审核标志
END
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA01JGXXB') and name = 'CHECK_TIME') BEGIN
    ALTER TABLE TA01JGXXB ADD  CHECK_TIME DATETIME                      --审核时间
END
--1.2.4. TA02GDXXB 股东信息表
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA02GDXXB') and name = 'CHECK_FLAG') BEGIN
    ALTER TABLE TA02GDXXB ADD  CHECK_FLAG INTEGER   NOT NULL DEFAULT 1   --审核标志
END
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA02GDXXB') and name = 'CHECK_TIME') BEGIN
    ALTER TABLE TA02GDXXB ADD  CHECK_TIME DATETIME                      --审核时间
END

--1.2.5. TA03YGXXB 员工信息表
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA03YGXXB') and name = 'CHECK_FLAG') BEGIN
    ALTER TABLE TA03YGXXB ADD  CHECK_FLAG INTEGER   NOT NULL DEFAULT 1   --审核标志
END
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA03YGXXB') and name = 'CHECK_TIME') BEGIN
    ALTER TABLE TA03YGXXB ADD  CHECK_TIME DATETIME                      --审核时间
END
--1.2.4. TA04GLFXXB 关联方信息表
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA04GLFXXB') and name = 'CHECK_FLAG') BEGIN
    ALTER TABLE TA04GLFXXB ADD  CHECK_FLAG INTEGER   NOT NULL DEFAULT 1   --审核标志
END
IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('TA04GLFXXB') and name = 'CHECK_TIME') BEGIN
    ALTER TABLE TA04GLFXXB ADD  CHECK_TIME DATETIME                      --审核时间
END
GO


---2.数据处理
--2.1. 字典9003
IF NOT EXISTS(SELECT 1 FROM TEDICTPARAM WHERE TYPE_ID = 9003 AND TYPE_VALUE = 1) BEGIN
    INSERT INTO TEDICTPARAM(TYPE_ID,TYPE_NAME,TYPE_VALUE,TYPE_CONTENT)
        VALUES('9003',    '表申报标志' ,'1' , '申报表')

END
IF NOT EXISTS(SELECT 1 FROM TEDICTPARAM WHERE TYPE_ID = 9003 AND TYPE_VALUE = 1) BEGIN
    INSERT INTO TEDICTPARAM(TYPE_ID,TYPE_NAME,TYPE_VALUE,TYPE_CONTENT)
        VALUES('9003',    '表申报标志' ,'2' , '申报表扩展')

END
IF NOT EXISTS(SELECT 1 FROM TEDICTPARAM WHERE TYPE_ID = 9003 AND TYPE_VALUE = 9) BEGIN
    INSERT INTO TEDICTPARAM(TYPE_ID,TYPE_NAME,TYPE_VALUE,TYPE_CONTENT)
        VALUES('9003',    '表申报标志' ,'9' , '其他表')

END
GO


--3.写入版本信息
IF EXISTS(SELECT 1 FROM TEVERSIONDETAIL )
INSERT INTO TEVERSIONDETAIL(VERSION_NO,RELEASE_DATE,SUMMARY)
    SELECT N'V 1.0.200326',
           20200326,
           N'1.增加部门表 TEDEPART; 2.添加系统版本信息表TEVERSIONDETAIL 3.TEREPORT 增加字段 REPORT_FLAG 以及 对应字典(9003)'

UPDATE TESYSTEMINFO
    SET VERSION_NO = N'V 1.0.200326'